openapi: 3.0.3
info:
  title: Metron Screen-Time Orchestration API
  description: |
    Metron is a unified screen-time orchestration system that tracks children's screen time
    across multiple devices (TV, PS5, iPad, etc.) with driver-based integrations.

    This API provides endpoints for managing children, sessions, devices, and viewing statistics.

    ## Features
    - Multi-child session management
    - Device driver integration (Aqara Cloud, PS5, etc.)
    - Break rule enforcement
    - Daily usage tracking
    - Real-time session control

    ## Authentication
    All `/v1/*` endpoints require API key authentication via the `X-Metron-Key` header.
    The `/health` endpoint does not require authentication.

  version: 1.0.0
  contact:
    name: Metron API Support
    url: https://github.com/4rakcheev/metron
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://metron.example.com
    description: Production server

security:
  - ApiKeyAuth: []

tags:
  - name: Health
    description: Service health check
  - name: Children
    description: Manage children and view their screen-time limits
  - name: Devices
    description: List available device types and capabilities
  - name: Sessions
    description: Manage screen-time sessions
  - name: Statistics
    description: View usage statistics
  - name: Admin
    description: Administrative endpoints for driver management
  - name: Downtime
    description: Downtime schedule management
  - name: Agent
    description: Agent endpoints for external device agents (Windows agent, etc.)
  - name: Bypass
    description: Device bypass mode management

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the service. No authentication required.
      operationId: getHealth
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: UP
                service: metron

  /v1/children:
    get:
      tags:
        - Children
      summary: List all children
      description: Returns a list of all registered children with their screen-time limits and break rules
      operationId: listChildren
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Child'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'
    post:
      tags:
        - Children
      summary: Create a new child
      description: Registers a new child with screen-time limits and optional break rules
      operationId: createChild
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateChildRequest'
            examples:
              basic:
                summary: Child without break rule
                value:
                  name: Alice
                  weekday_limit: 60
                  weekend_limit: 120
              withBreakRule:
                summary: Child with break rule
                value:
                  name: Bob
                  weekday_limit: 90
                  weekend_limit: 150
                  break_rule:
                    break_after_minutes: 45
                    break_duration_minutes: 10
      responses:
        '201':
          description: Child created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Child'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/children/{id}:
    get:
      tags:
        - Children
      summary: Get child details
      description: Returns detailed information about a specific child including today's usage statistics
      operationId: getChild
      parameters:
        - name: id
          in: path
          required: true
          description: Child ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChildWithStatus'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/ChildNotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'
    patch:
      tags:
        - Children
      summary: Update child
      description: Updates a child's name, limits, or break rules
      operationId: updateChild
      parameters:
        - name: id
          in: path
          required: true
          description: Child ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateChildRequest'
            examples:
              updateLimits:
                summary: Update daily limits
                value:
                  weekday_limit: 90
                  weekend_limit: 150
              updateBreakRule:
                summary: Add/update break rule
                value:
                  break_rule:
                    break_after_minutes: 60
                    break_duration_minutes: 15
              updateName:
                summary: Update child's name
                value:
                  name: Alice Johnson
      responses:
        '200':
          description: Child updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Child'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/ChildNotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'
    delete:
      tags:
        - Children
      summary: Delete child
      description: Removes a child from the system
      operationId: deleteChild
      parameters:
        - name: id
          in: path
          required: true
          description: Child ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Child deleted successfully (no content)
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/ChildNotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/children/{id}/rewards:
    post:
      tags:
        - Children
      summary: Grant reward minutes
      description: Adds bonus screen-time minutes to a child's daily limit as a reward
      operationId: grantReward
      parameters:
        - name: id
          in: path
          required: true
          description: Child ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RewardFineRequest'
            example:
              minutes: 30
      responses:
        '200':
          description: Reward granted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RewardFineResponse'
              example:
                success: true
                message: Granted 30 reward minutes
                minutes: 30
                new_remaining: 90
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/ChildNotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/children/{id}/fines:
    post:
      tags:
        - Children
      summary: Deduct fine minutes
      description: Deducts screen-time minutes from a child's daily limit as a penalty
      operationId: deductFine
      parameters:
        - name: id
          in: path
          required: true
          description: Child ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RewardFineRequest'
            example:
              minutes: 15
      responses:
        '200':
          description: Fine deducted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RewardFineResponse'
              example:
                success: true
                message: Deducted 15 fine minutes
                minutes: 15
                new_remaining: 45
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/ChildNotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/devices:
    get:
      tags:
        - Devices
      summary: List available devices
      description: Returns all available device types and their capabilities
      operationId: listDevices
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Device'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/sessions:
    get:
      tags:
        - Sessions
      summary: List sessions
      description: Returns a list of sessions with optional filtering by child, active status, or date
      operationId: listSessions
      parameters:
        - name: childId
          in: query
          description: Filter sessions by child ID
          schema:
            type: string
            format: uuid
        - name: active
          in: query
          description: Filter by active status
          schema:
            type: boolean
        - name: date
          in: query
          description: Filter by date (YYYY-MM-DD)
          schema:
            type: string
            format: date
            example: "2025-12-09"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Session'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'
    post:
      tags:
        - Sessions
      summary: Start a new session
      description: Creates and starts a new screen-time session for one or more children
      operationId: createSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSessionRequest'
            examples:
              singleChild:
                summary: Session for one child
                value:
                  device_type: tv
                  device_id: tv1
                  child_ids:
                    - "550e8400-e29b-41d4-a716-446655440000"
                  minutes: 30
              multipleChildren:
                summary: Shared session for multiple children
                value:
                  device_type: tv
                  child_ids:
                    - "550e8400-e29b-41d4-a716-446655440000"
                    - "660e8400-e29b-41d4-a716-446655440001"
                  minutes: 60
      responses:
        '201':
          description: Session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/sessions/{id}:
    get:
      tags:
        - Sessions
      summary: Get session details
      description: Returns detailed information about a specific session
      operationId: getSession
      parameters:
        - name: id
          in: path
          required: true
          description: Session ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/SessionNotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'
    patch:
      tags:
        - Sessions
      summary: Update session
      description: Extends or stops an existing session
      operationId: updateSession
      parameters:
        - name: id
          in: path
          required: true
          description: Session ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSessionRequest'
            examples:
              extend:
                summary: Extend session by 15 minutes
                value:
                  action: extend
                  additional_minutes: 15
              stop:
                summary: Stop session
                value:
                  action: stop
      responses:
        '200':
          description: Session extended successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'
        '204':
          description: Session stopped successfully (no content)
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/SessionNotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/stats/today:
    get:
      tags:
        - Statistics
      summary: Get today's statistics
      description: Returns usage statistics for all children for the current day
      operationId: getTodayStats
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TodayStats'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/admin/aqara/refresh-token:
    post:
      tags:
        - Admin
      summary: Update Aqara refresh token
      description: |
        Updates the Aqara Cloud API refresh token. This token is used to authenticate
        with the Aqara Cloud API for device control operations.

        After updating the refresh token, the access token cache is cleared and a new
        access token will be obtained on the next API call.
      operationId: updateAqaraRefreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAqaraTokenRequest'
            example:
              refresh_token: "your-new-refresh-token"
      responses:
        '200':
          description: Refresh token updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateAqaraTokenResponse'
              example:
                message: Refresh token updated successfully
                updated_at: "2025-12-09T15:30:45Z"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/admin/aqara/token-status:
    get:
      tags:
        - Admin
      summary: Get Aqara token status
      description: |
        Returns the current status of Aqara tokens, including whether a refresh token
        is configured and the status of the cached access token.
      operationId: getAqaraTokenStatus
      responses:
        '200':
          description: Token status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AqaraTokenStatus'
              examples:
                configured:
                  summary: Tokens configured and valid
                  value:
                    configured: true
                    refresh_token_updated_at: "2025-12-09T15:30:45Z"
                    access_token_status: valid
                    access_token_expires_in_seconds: 3600
                notConfigured:
                  summary: No refresh token configured
                  value:
                    configured: false
                    message: "No refresh token configured. Use POST /v1/admin/aqara/refresh-token to add one."
                expired:
                  summary: Access token expired
                  value:
                    configured: true
                    refresh_token_updated_at: "2025-12-09T10:00:00Z"
                    access_token_status: expired
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/downtime/skip-today:
    post:
      tags:
        - Downtime
      summary: Skip downtime for today
      description: |
        Skips the downtime enforcement for the current day. This affects all children
        and allows sessions to be created during normally restricted hours.

        The skip applies only to the current calendar day and resets at midnight.
      operationId: skipDowntimeToday
      responses:
        '200':
          description: Downtime skipped successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SkipDowntimeResponse'
              example:
                success: true
                skip_date: "2025-12-09"
                message: "Downtime skipped for today (all children)"
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/downtime/skip-status:
    get:
      tags:
        - Downtime
      summary: Get downtime skip status
      description: |
        Returns whether downtime is currently skipped for today and the date
        of the last skip (if any).
      operationId: getDowntimeSkipStatus
      responses:
        '200':
          description: Skip status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DowntimeSkipStatus'
              examples:
                skippedToday:
                  summary: Downtime is skipped today
                  value:
                    skipped_today: true
                    skip_date: "2025-12-09"
                notSkipped:
                  summary: Downtime is not skipped
                  value:
                    skipped_today: false
                    skip_date: null
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/agent/session:
    get:
      tags:
        - Agent
      summary: Get device session status
      description: |
        Returns the current session status for a device. Used by external agents
        (e.g., Windows agent) to poll for active sessions and determine enforcement actions.

        This endpoint uses Bearer token authentication instead of X-Metron-Key.
        Each agent token is tied to a specific device and can only query that device.
      operationId: getAgentSession
      security:
        - BearerAuth: []
      parameters:
        - name: device_id
          in: query
          required: true
          description: Device ID to query session status for
          schema:
            type: string
            example: win-pc1
      responses:
        '200':
          description: Session status returned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentSessionStatus'
              examples:
                activeSession:
                  summary: Active session
                  value:
                    active: true
                    session_id: "770e8400-e29b-41d4-a716-446655440002"
                    ends_at: "2025-12-09T16:00:45Z"
                    warn_at: "2025-12-09T15:55:45Z"
                    server_time: "2025-12-09T15:30:45Z"
                    bypass_mode: false
                noSession:
                  summary: No active session
                  value:
                    active: false
                    bypass_mode: false
                    server_time: "2025-12-09T15:30:45Z"
                bypassActive:
                  summary: Bypass mode active
                  value:
                    active: false
                    bypass_mode: true
                    server_time: "2025-12-09T15:30:45Z"
        '400':
          description: Missing device_id parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: device_id query parameter required
                code: DEVICE_ID_REQUIRED
        '401':
          description: Missing or invalid authorization token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                authRequired:
                  value:
                    error: Authorization header required
                    code: AUTH_REQUIRED
                invalidToken:
                  value:
                    error: Invalid token
                    code: INVALID_TOKEN
        '403':
          description: Token not authorized for this device
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: Not authorized for this device
                code: DEVICE_NOT_AUTHORIZED
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/devices/{id}/bypass:
    post:
      tags:
        - Bypass
      summary: Set device bypass mode
      description: |
        Enable or disable bypass mode for a device. When bypass is active,
        agents will skip enforcement and allow unrestricted access.

        Bypass can be set with an optional expiration time.
      operationId: setDeviceBypass
      parameters:
        - name: id
          in: path
          required: true
          description: Device ID
          schema:
            type: string
            example: win-pc1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetBypassRequest'
            examples:
              enableWithExpiry:
                summary: Enable bypass for 1 hour
                value:
                  enabled: true
                  reason: homework
                  expires_in_minutes: 60
              enableIndefinite:
                summary: Enable indefinite bypass
                value:
                  enabled: true
                  reason: special occasion
              disable:
                summary: Disable bypass
                value:
                  enabled: false
      responses:
        '200':
          description: Bypass mode updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BypassStatus'
              examples:
                enabled:
                  value:
                    device_id: win-pc1
                    enabled: true
                    reason: homework
                    enabled_at: "2025-12-09T15:30:45Z"
                    expires_at: "2025-12-09T16:30:45Z"
                disabled:
                  value:
                    device_id: win-pc1
                    enabled: false
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'
    delete:
      tags:
        - Bypass
      summary: Clear device bypass mode
      description: Remove bypass mode for a device, re-enabling normal enforcement.
      operationId: clearDeviceBypass
      parameters:
        - name: id
          in: path
          required: true
          description: Device ID
          schema:
            type: string
            example: win-pc1
      responses:
        '204':
          description: Bypass cleared successfully (no content)
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-Metron-Key
      description: API key for admin authentication
    BearerAuth:
      type: http
      scheme: bearer
      description: Bearer token for agent authentication. Each token is tied to a specific device.

  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - service
      properties:
        status:
          type: string
          enum: [UP, DOWN]
          description: Health status of the service
        service:
          type: string
          description: Service name
          example: metron

    Child:
      type: object
      required:
        - id
        - name
        - weekday_limit
        - weekend_limit
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the child
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          description: Child's name
          example: Alice
          minLength: 1
        weekday_limit:
          type: integer
          description: Daily screen-time limit for weekdays (minutes)
          minimum: 1
          example: 60
        weekend_limit:
          type: integer
          description: Daily screen-time limit for weekends (minutes)
          minimum: 1
          example: 120
        break_rule:
          $ref: '#/components/schemas/BreakRule'
        created_at:
          type: string
          format: date-time
          description: When the child record was created
          example: "2025-12-09T15:30:45Z"
        updated_at:
          type: string
          format: date-time
          description: When the child record was last updated
          example: "2025-12-09T15:30:45Z"

    ChildWithStatus:
      allOf:
        - $ref: '#/components/schemas/Child'
        - type: object
          required:
            - today_used
            - today_remaining
            - today_limit
            - sessions_today
          properties:
            today_used:
              type: integer
              description: Minutes used today
              minimum: 0
              example: 30
            today_remaining:
              type: integer
              description: Minutes remaining today
              minimum: 0
              example: 30
            today_limit:
              type: integer
              description: Total daily limit for today
              minimum: 0
              example: 60
            sessions_today:
              type: integer
              description: Number of sessions today
              minimum: 0
              example: 2

    BreakRule:
      type: object
      required:
        - break_after_minutes
        - break_duration_minutes
      properties:
        break_after_minutes:
          type: integer
          description: Require a break after this many minutes
          minimum: 1
          example: 45
        break_duration_minutes:
          type: integer
          description: Break must last this many minutes
          minimum: 1
          example: 10
      nullable: true

    Device:
      type: object
      required:
        - type
        - name
      properties:
        type:
          type: string
          description: Device type identifier
          example: aqara
        name:
          type: string
          description: Human-readable device name
          example: aqara
        capabilities:
          $ref: '#/components/schemas/DeviceCapabilities'

    DeviceCapabilities:
      type: object
      properties:
        supports_warnings:
          type: boolean
          description: Whether the device supports time-remaining warnings
          example: true
        supports_live_state:
          type: boolean
          description: Whether the device supports live state queries
          example: true
        supports_scheduling:
          type: boolean
          description: Whether the device supports scheduled sessions
          example: false

    Session:
      type: object
      required:
        - id
        - device_type
        - device_id
        - child_ids
        - start_time
        - expected_duration
        - remaining_minutes
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique session identifier
          example: "770e8400-e29b-41d4-a716-446655440002"
        device_type:
          type: string
          description: Type of device (tv, ps5, ipad, etc.)
          example: tv
        device_id:
          type: string
          description: Specific device identifier
          example: tv1
        child_ids:
          type: array
          items:
            type: string
            format: uuid
          description: IDs of children in this session
          minItems: 1
          example: ["550e8400-e29b-41d4-a716-446655440000"]
        start_time:
          type: string
          format: date-time
          description: When the session started
          example: "2025-12-09T15:30:45Z"
        expected_duration:
          type: integer
          description: Expected session duration in minutes
          minimum: 1
          example: 30
        remaining_minutes:
          type: integer
          description: Minutes remaining in the session
          minimum: 0
          example: 25
        status:
          type: string
          enum: [active, paused, completed, expired]
          description: Current session status
          example: active
        last_break_at:
          type: string
          format: date-time
          description: When the last break started
          nullable: true
          example: "2025-12-09T16:15:45Z"
        break_ends_at:
          type: string
          format: date-time
          description: When the current break ends
          nullable: true
          example: "2025-12-09T16:25:45Z"
        created_at:
          type: string
          format: date-time
          description: When the session was created
          example: "2025-12-09T15:30:45Z"
        updated_at:
          type: string
          format: date-time
          description: When the session was last updated
          example: "2025-12-09T15:31:00Z"

    CreateSessionRequest:
      type: object
      required:
        - device_type
        - child_ids
        - minutes
      properties:
        device_type:
          type: string
          description: Type of device for the session
          example: tv
          minLength: 1
        device_id:
          type: string
          description: Specific device ID (optional, defaults to {device_type}1)
          example: tv1
        child_ids:
          type: array
          items:
            type: string
            format: uuid
          description: IDs of children for this session
          minItems: 1
          example: ["550e8400-e29b-41d4-a716-446655440000"]
        minutes:
          type: integer
          description: Duration of the session in minutes
          minimum: 1
          maximum: 1440
          example: 30

    UpdateSessionRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum: [extend, stop]
          description: Action to perform on the session
          example: extend
        additional_minutes:
          type: integer
          description: Additional minutes to add (required when action is 'extend')
          minimum: 1
          maximum: 1440
          example: 15

    CreateChildRequest:
      type: object
      required:
        - name
        - weekday_limit
        - weekend_limit
      properties:
        name:
          type: string
          description: Child's name
          example: Alice
          minLength: 1
        weekday_limit:
          type: integer
          description: Daily screen-time limit for weekdays (minutes)
          minimum: 1
          example: 60
        weekend_limit:
          type: integer
          description: Daily screen-time limit for weekends (minutes)
          minimum: 1
          example: 120
        break_rule:
          $ref: '#/components/schemas/BreakRule'

    UpdateChildRequest:
      type: object
      properties:
        name:
          type: string
          description: Child's name (optional)
          example: Alice
          minLength: 1
        weekday_limit:
          type: integer
          description: Daily screen-time limit for weekdays in minutes (optional)
          minimum: 1
          example: 90
        weekend_limit:
          type: integer
          description: Daily screen-time limit for weekends in minutes (optional)
          minimum: 1
          example: 150
        break_rule:
          allOf:
            - $ref: '#/components/schemas/BreakRule'
          description: Mandatory break rule (optional)
          nullable: true

    RewardFineRequest:
      type: object
      required:
        - minutes
      properties:
        minutes:
          type: integer
          description: Number of minutes to add (reward) or deduct (fine)
          enum: [15, 30, 60]
          example: 30

    RewardFineResponse:
      type: object
      required:
        - success
        - message
        - minutes
        - new_remaining
      properties:
        success:
          type: boolean
          description: Whether the operation succeeded
          example: true
        message:
          type: string
          description: Human-readable success message
          example: "Granted 30 reward minutes"
        minutes:
          type: integer
          description: Number of minutes added or deducted
          example: 30
        new_remaining:
          type: integer
          description: New remaining minutes after the operation
          example: 90

    UpdateAqaraTokenRequest:
      type: object
      required:
        - refresh_token
      properties:
        refresh_token:
          type: string
          description: The new Aqara Cloud API refresh token
          example: "your-refresh-token-here"

    UpdateAqaraTokenResponse:
      type: object
      required:
        - message
        - updated_at
      properties:
        message:
          type: string
          description: Success message
          example: "Refresh token updated successfully"
        updated_at:
          type: string
          format: date-time
          description: When the token was updated
          example: "2025-12-09T15:30:45Z"

    AqaraTokenStatus:
      type: object
      required:
        - configured
      properties:
        configured:
          type: boolean
          description: Whether a refresh token is configured
          example: true
        message:
          type: string
          description: Status message (only when not configured)
          example: "No refresh token configured. Use POST /v1/admin/aqara/refresh-token to add one."
        refresh_token_updated_at:
          type: string
          format: date-time
          description: When the refresh token was last updated (only when configured)
          example: "2025-12-09T15:30:45Z"
        access_token_status:
          type: string
          enum: [not_cached, cached_no_expiry, valid, expired]
          description: Status of the cached access token (only when configured)
          example: valid
        access_token_expires_in_seconds:
          type: integer
          description: Seconds until access token expires (only when status is 'valid')
          example: 3600

    SkipDowntimeResponse:
      type: object
      required:
        - success
        - skip_date
        - message
      properties:
        success:
          type: boolean
          description: Whether the operation succeeded
          example: true
        skip_date:
          type: string
          format: date
          description: The date for which downtime was skipped
          example: "2025-12-09"
        message:
          type: string
          description: Success message
          example: "Downtime skipped for today (all children)"

    DowntimeSkipStatus:
      type: object
      required:
        - skipped_today
      properties:
        skipped_today:
          type: boolean
          description: Whether downtime is skipped for today
          example: true
        skip_date:
          type: string
          format: date
          description: The date of the last skip (null if never skipped)
          nullable: true
          example: "2025-12-09"

    TodayStats:
      type: object
      required:
        - date
        - children
        - active_sessions
        - total_children
      properties:
        date:
          type: string
          format: date
          description: Date of the statistics
          example: "2025-12-09"
        children:
          type: array
          items:
            $ref: '#/components/schemas/ChildStats'
          description: Statistics for each child
        active_sessions:
          type: integer
          description: Number of currently active sessions
          minimum: 0
          example: 1
        total_children:
          type: integer
          description: Total number of registered children
          minimum: 0
          example: 2

    ChildStats:
      type: object
      required:
        - child_id
        - child_name
        - today_used
        - today_remaining
        - today_limit
        - sessions_today
        - usage_percent
      properties:
        child_id:
          type: string
          format: uuid
          description: Child's unique identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        child_name:
          type: string
          description: Child's name
          example: Alice
        today_used:
          type: integer
          description: Minutes used today
          minimum: 0
          example: 30
        today_remaining:
          type: integer
          description: Minutes remaining today
          minimum: 0
          example: 30
        today_limit:
          type: integer
          description: Total daily limit
          minimum: 0
          example: 60
        sessions_today:
          type: integer
          description: Number of sessions today
          minimum: 0
          example: 2
        usage_percent:
          type: integer
          description: Percentage of daily limit used
          minimum: 0
          maximum: 100
          example: 50

    Error:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          description: Human-readable error message
          example: Session not found
        code:
          type: string
          description: Machine-readable error code
          example: SESSION_NOT_FOUND
        details:
          type: string
          description: Additional error details (optional)
          example: Invalid JSON in request body

    AgentSessionStatus:
      type: object
      required:
        - active
        - bypass_mode
        - server_time
      properties:
        active:
          type: boolean
          description: Whether there is an active session for the device
          example: true
        session_id:
          type: string
          format: uuid
          description: ID of the active session (only present if active)
          example: "770e8400-e29b-41d4-a716-446655440002"
        ends_at:
          type: string
          format: date-time
          description: When the session ends (only present if active)
          example: "2025-12-09T16:00:45Z"
        warn_at:
          type: string
          format: date-time
          description: When to show warning, 5 minutes before ends_at (only present if active)
          example: "2025-12-09T15:55:45Z"
        server_time:
          type: string
          format: date-time
          description: Current server time for clock synchronization
          example: "2025-12-09T15:30:45Z"
        bypass_mode:
          type: boolean
          description: Whether bypass mode is active (agent should skip enforcement)
          example: false

    SetBypassRequest:
      type: object
      required:
        - enabled
      properties:
        enabled:
          type: boolean
          description: Whether to enable or disable bypass
          example: true
        reason:
          type: string
          description: Optional reason for enabling bypass
          example: homework
        expires_in_minutes:
          type: integer
          description: Minutes until bypass expires. Omit for indefinite bypass.
          minimum: 1
          example: 60

    BypassStatus:
      type: object
      required:
        - device_id
        - enabled
      properties:
        device_id:
          type: string
          description: Device ID
          example: win-pc1
        enabled:
          type: boolean
          description: Whether bypass is enabled
          example: true
        reason:
          type: string
          description: Reason for bypass (only present if enabled)
          example: homework
        enabled_at:
          type: string
          format: date-time
          description: When bypass was enabled (only present if enabled)
          example: "2025-12-09T15:30:45Z"
        expires_at:
          type: string
          format: date-time
          description: When bypass expires (only present if enabled with expiry)
          example: "2025-12-09T16:30:45Z"

  responses:
    UnauthorizedError:
      description: Missing or invalid API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Unauthorized
            code: UNAUTHORIZED

    BadRequestError:
      description: Invalid request parameters or body
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            invalidRequest:
              summary: Invalid request body
              value:
                error: Invalid request body
                code: INVALID_REQUEST
                details: "minutes must be positive"
            insufficientTime:
              summary: Insufficient time remaining
              value:
                error: Child has insufficient remaining time
                code: INSUFFICIENT_TIME
            invalidAction:
              summary: Invalid action
              value:
                error: Invalid action. Must be 'extend' or 'stop'
                code: INVALID_ACTION

    SessionNotFoundError:
      description: Session not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Session not found
            code: SESSION_NOT_FOUND

    ChildNotFoundError:
      description: Child not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Child not found
            code: CHILD_NOT_FOUND

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Internal server error
            code: INTERNAL_ERROR
