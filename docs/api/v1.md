# Metron REST API v1 Documentation

## Overview

Metron uses the Gin framework with TMF630 REST API guidelines. All endpoints are mounted under `/v1/` and require authentication (except `/health`).

## Authentication

### Admin Authentication (X-Metron-Key)

Most `/v1/*` endpoints require the `X-Metron-Key` header:

```bash
curl -H "X-Metron-Key: your-api-key-here" http://localhost:8080/v1/children
```

### Agent Authentication (Bearer Token)

Agent endpoints (`/v1/agent/*`) use Bearer token authentication with per-device tokens:

```bash
curl -H "Authorization: Bearer your-agent-token" \
  "http://localhost:8080/v1/agent/session?device_id=win-pc1"
```

Agent tokens are configured in the `security.agent_tokens` section of the config file. Each token is tied to a specific device ID.

## Endpoints

### Health Check

#### GET /health

No authentication required. Returns service health status.

**Response:**
```json
{
  "status": "UP",
  "service": "metron"
}
```

---

### Children

#### GET /v1/children

List all children with their screen-time limits.

**Response:**
```json
[
  {
    "id": "child-uuid",
    "name": "Alice",
    "emoji": "üëß",
    "weekday_limit": 60,
    "weekend_limit": 120,
    "break_rule": {
      "break_after_minutes": 45,
      "break_duration_minutes": 10
    },
    "downtime_enabled": true,
    "created_at": "2025-12-09T15:30:45Z",
    "updated_at": "2025-12-09T15:30:45Z"
  }
]
```

#### POST /v1/children

Create a new child.

**Request Body:**
```json
{
  "name": "Alice",
  "emoji": "üëß",
  "pin": "1234",
  "weekday_limit": 60,
  "weekend_limit": 120,
  "break_rule": {
    "break_after_minutes": 45,
    "break_duration_minutes": 10
  }
}
```

**Fields:**
- `name` (required): Child's display name
- `emoji` (optional): Emoji icon for the child (randomly assigned if not provided)
- `pin` (optional): 4-digit PIN for child authentication in the web UI
- `weekday_limit` (required): Daily screen time limit in minutes for Mon-Fri
- `weekend_limit` (required): Daily screen time limit in minutes for Sat-Sun
- `break_rule` (optional): Mandatory break configuration

**Response:** (201 Created)
```json
{
  "id": "child-uuid",
  "name": "Alice",
  "emoji": "üëß",
  "pin": "1234",
  "weekday_limit": 60,
  "weekend_limit": 120,
  "break_rule": {
    "break_after_minutes": 45,
    "break_duration_minutes": 10
  },
  "downtime_enabled": false,
  "created_at": "2025-12-09T15:30:45Z",
  "updated_at": "2025-12-09T15:30:45Z"
}
```

#### GET /v1/children/:id

Get detailed information about a specific child, including today's usage.

**Response:**
```json
{
  "id": "child-uuid",
  "name": "Alice",
  "emoji": "üëß",
  "pin": "1234",
  "weekday_limit": 60,
  "weekend_limit": 120,
  "break_rule": {
    "break_after_minutes": 45,
    "break_duration_minutes": 10
  },
  "downtime_enabled": true,
  "created_at": "2025-12-09T15:30:45Z",
  "updated_at": "2025-12-09T15:30:45Z",
  "today_used": 30,
  "today_reward_granted": 15,
  "today_remaining": 45,
  "today_limit": 60,
  "sessions_today": 2
}
```

**Note:** `today_reward_granted` can be negative when fines have been applied.

#### PATCH /v1/children/:id

Update a child's settings. All fields are optional - only provided fields will be updated.

**Request Body:** (all fields optional)
```json
{
  "name": "Alice Johnson",
  "emoji": "üåü",
  "pin": "5678",
  "weekday_limit": 90,
  "weekend_limit": 150,
  "downtime_enabled": true,
  "break_rule": {
    "break_after_minutes": 60,
    "break_duration_minutes": 15
  }
}
```

**Fields:**
- `name`: Child's display name
- `emoji`: Emoji icon (set to empty string to randomly reassign)
- `pin`: 4-digit PIN for web UI authentication
- `weekday_limit`: Daily limit in minutes for Mon-Fri
- `weekend_limit`: Daily limit in minutes for Sat-Sun
- `downtime_enabled`: Whether downtime schedule is enforced for this child
- `break_rule`: Mandatory break configuration

**Response:** (200 OK)
```json
{
  "id": "child-uuid",
  "name": "Alice Johnson",
  "emoji": "üåü",
  "pin": "5678",
  "weekday_limit": 90,
  "weekend_limit": 150,
  "break_rule": {
    "break_after_minutes": 60,
    "break_duration_minutes": 15
  },
  "downtime_enabled": true,
  "created_at": "2025-12-09T15:30:45Z",
  "updated_at": "2025-12-09T16:00:00Z"
}
```

#### DELETE /v1/children/:id

Delete a child from the system.

**Response:** (204 No Content)

**Error Responses:**
- `404` - Child not found

---

### Devices

#### GET /v1/devices

List all registered devices with their capabilities.

**Response:**
```json
[
  {
    "id": "tv1",
    "name": "Living Room TV",
    "type": "tv",
    "capabilities": {
      "supports_warnings": true,
      "supports_live_state": false,
      "supports_scheduling": true
    }
  },
  {
    "id": "tv2",
    "name": "Bedroom TV",
    "type": "tv",
    "capabilities": {
      "supports_warnings": true,
      "supports_live_state": false,
      "supports_scheduling": true
    }
  }
]
```

**Note:** Capabilities come from the device's associated driver.

---

### Sessions

#### GET /v1/sessions

List sessions with optional filtering.

**Query Parameters:**
- `childId` - Filter by child ID
- `active` - Filter active sessions (true/false)
- `date` - Filter by date (YYYY-MM-DD)

**Examples:**
```bash
# List all active sessions
GET /v1/sessions?active=true

# List sessions for a specific child
GET /v1/sessions?childId=child-uuid

# List sessions for a specific date
GET /v1/sessions?date=2025-12-09
```

**Response:**
```json
[
  {
    "id": "session-uuid",
    "device_type": "tv",
    "device_id": "tv1",
    "child_ids": ["child-uuid"],
    "start_time": "2025-12-09T15:30:45Z",
    "expected_duration": 30,
    "remaining_minutes": 25,
    "status": "active",
    "created_at": "2025-12-09T15:30:45Z",
    "updated_at": "2025-12-09T15:30:45Z"
  }
]
```

#### POST /v1/sessions

Start a new session.

**Request Body:**
```json
{
  "device_id": "tv1",
  "child_ids": ["child-uuid-1", "child-uuid-2"],
  "minutes": 30
}
```

**Fields:**
- `device_id` (required): Device ID from global device registry (max 15 chars)
- `child_ids` (required): Array of child UUIDs
- `minutes` (required): Session duration in minutes

**Response:** (201 Created)
```json
{
  "id": "session-uuid",
  "device_type": "tv",
  "device_id": "tv1",
  "child_ids": ["child-uuid-1", "child-uuid-2"],
  "start_time": "2025-12-09T15:30:45Z",
  "expected_duration": 30,
  "remaining_minutes": 30,
  "status": "active",
  "created_at": "2025-12-09T15:30:45Z",
  "updated_at": "2025-12-09T15:30:45Z"
}
```

**Note:** `device_type` in response comes from the device's configured type.

**Error Responses:**
- `400` - Invalid request or insufficient time
- `401` - Unauthorized

#### GET /v1/sessions/:id

Get details of a specific session.

**Response:**
```json
{
  "id": "session-uuid",
  "device_type": "tv",
  "device_id": "tv1",
  "child_ids": ["child-uuid"],
  "start_time": "2025-12-09T15:30:45Z",
  "expected_duration": 30,
  "remaining_minutes": 25,
  "status": "active",
  "created_at": "2025-12-09T15:30:45Z",
  "updated_at": "2025-12-09T15:30:45Z"
}
```

#### PATCH /v1/sessions/:id

Update a session (extend or stop).

**Extend Session:**
```json
{
  "action": "extend",
  "additional_minutes": 15
}
```

**Response:** (200 OK)
```json
{
  "id": "session-uuid",
  "device_type": "tv",
  "device_id": "tv1",
  "child_ids": ["child-uuid"],
  "start_time": "2025-12-09T15:30:45Z",
  "expected_duration": 45,
  "remaining_minutes": 40,
  "status": "active",
  "created_at": "2025-12-09T15:30:45Z",
  "updated_at": "2025-12-09T15:31:00Z"
}
```

**Stop Session:**
```json
{
  "action": "stop"
}
```

**Response:** (204 No Content)

**Error Responses:**
- `400` - Invalid action or insufficient time
- `404` - Session not found

---

### Downtime

#### POST /v1/downtime/skip-today

Skip downtime for all children today. The skip automatically expires at midnight.

**Response:** (204 No Content)

**Error Responses:**
- `401` - Unauthorized
- `500` - Failed to set skip date

#### GET /v1/downtime/skip-status

Check if downtime is currently skipped for today.

**Response:**
```json
{
  "skipped_today": true,
  "skip_date": "2025-12-09"
}
```

If downtime is not skipped:
```json
{
  "skipped_today": false,
  "skip_date": null
}
```

---

### Agent

Agent endpoints are used by external agents (e.g., Windows agent) to poll for session status. These endpoints use Bearer token authentication instead of X-Metron-Key.

#### GET /v1/agent/session

Get current session status for a device. Used by agents to determine if access should be allowed.

**Query Parameters:**
- `device_id` (required) - Device ID to check

**Headers:**
- `Authorization: Bearer <agent-token>` (required)

**Response (active session):**
```json
{
  "active": true,
  "session_id": "session-uuid",
  "ends_at": "2025-12-09T16:00:45Z",
  "warn_at": "2025-12-09T15:55:45Z",
  "server_time": "2025-12-09T15:30:45Z",
  "bypass_mode": false
}
```

**Response (no active session):**
```json
{
  "active": false,
  "bypass_mode": false,
  "server_time": "2025-12-09T15:30:45Z"
}
```

**Response (bypass mode active):**
```json
{
  "active": false,
  "bypass_mode": true,
  "server_time": "2025-12-09T15:30:45Z"
}
```

**Fields:**
- `active`: Whether there is an active session for this device
- `session_id`: ID of the active session (only if active)
- `ends_at`: When the session ends (ISO 8601)
- `warn_at`: When to show warning (5 minutes before ends_at)
- `server_time`: Current server time (for clock sync)
- `bypass_mode`: Whether bypass is enabled (agent should skip enforcement)

**Error Responses:**
- `400` - Missing device_id parameter
- `401` - Missing or invalid authorization token
- `403` - Token not authorized for this device

---

### Bypass

Bypass endpoints allow parents to temporarily disable enforcement for a device. When bypass is active, agents will not enforce screen-time limits.

#### POST /v1/devices/:id/bypass

Enable or update bypass mode for a device.

**Request Body:**
```json
{
  "enabled": true,
  "reason": "homework",
  "expires_in_minutes": 60
}
```

**Fields:**
- `enabled` (required): true to enable, false to disable
- `reason` (optional): Human-readable reason for bypass
- `expires_in_minutes` (optional): When bypass should expire. If omitted, bypass is indefinite.

**Response (enabled):** (200 OK)
```json
{
  "device_id": "win-pc1",
  "enabled": true,
  "reason": "homework",
  "enabled_at": "2025-12-09T15:30:45Z",
  "expires_at": "2025-12-09T16:30:45Z"
}
```

**Response (disabled):** (200 OK)
```json
{
  "device_id": "win-pc1",
  "enabled": false
}
```

#### DELETE /v1/devices/:id/bypass

Remove bypass mode for a device. Returns 204 No Content on success.

**Example:**
```bash
curl -X DELETE http://localhost:8080/v1/devices/win-pc1/bypass \
  -H "X-Metron-Key: your-api-key"
```

---

### Movie Time Bypass (Admin API)

Movie time bypass periods allow enabling movie time on non-weekend days during holidays, school vacations, or special occasions.

#### GET /v1/admin/movie-time/bypasses

List all configured movie time bypass periods.

**Response:**
```json
{
  "bypasses": [
    {
      "id": "byp_550e8400-e29b-41d4-a716-446655440001",
      "reason": "Winter vacation",
      "start_date": "2025-12-20",
      "end_date": "2026-01-05",
      "created_at": "2025-12-15T10:00:00Z"
    }
  ]
}
```

#### POST /v1/admin/movie-time/bypasses

Create a new movie time bypass period.

**Request Body:**
```json
{
  "reason": "Winter vacation",
  "start_date": "2025-12-20",
  "end_date": "2026-01-05"
}
```

**Fields:**
- `reason` (required): Human-readable reason for the bypass
- `start_date` (required): Start date in YYYY-MM-DD format (inclusive)
- `end_date` (required): End date in YYYY-MM-DD format (inclusive)

**Response:** (201 Created)
```json
{
  "id": "byp_550e8400-e29b-41d4-a716-446655440001",
  "reason": "Winter vacation",
  "start_date": "2025-12-20",
  "end_date": "2026-01-05",
  "created_at": "2025-12-15T10:00:00Z"
}
```

**Error Responses:**
- `400` - Invalid date format or end_date before start_date

#### GET /v1/admin/movie-time/bypasses/:id

Get a specific bypass period by ID.

**Response:**
```json
{
  "id": "byp_550e8400-e29b-41d4-a716-446655440001",
  "reason": "Winter vacation",
  "start_date": "2025-12-20",
  "end_date": "2026-01-05",
  "created_at": "2025-12-15T10:00:00Z"
}
```

**Error Responses:**
- `404` - Bypass not found

#### DELETE /v1/admin/movie-time/bypasses/:id

Delete a bypass period.

**Response:** (200 OK)
```json
{
  "message": "Bypass deleted successfully"
}
```

**Error Responses:**
- `404` - Bypass not found

---

### Movie Time (Child API)

Movie time is a feature that provides a shared 2-hour session for all children, separate from their individual quotas. It requires a 1-hour break after the last personal session.

**Availability:**
- Available on weekends (Saturday or Sunday)
- Also available during bypass periods (holidays, vacations) configured by parents

These endpoints require child session authentication (cookie or Bearer token from child login).

#### GET /child/movie-time

Get movie time availability status.

**Headers:**
- `Authorization: Bearer <child-session-id>` or session cookie

**Response (available on weekend):**
```json
{
  "is_weekend": true,
  "is_bypass_active": false,
  "is_available": true,
  "is_used_today": false,
  "break_required": false,
  "break_minutes_left": 0,
  "can_start": true,
  "allowed_devices": ["tv1"],
  "duration_minutes": 120
}
```

**Response (available due to bypass):**
```json
{
  "is_weekend": false,
  "is_bypass_active": true,
  "bypass_reason": "Winter vacation",
  "is_available": true,
  "is_used_today": false,
  "break_required": false,
  "break_minutes_left": 0,
  "can_start": true,
  "allowed_devices": ["tv1"],
  "duration_minutes": 120
}
```

**Response (break required):**
```json
{
  "is_weekend": true,
  "is_bypass_active": false,
  "is_available": false,
  "is_used_today": false,
  "break_required": true,
  "break_minutes_left": 25,
  "last_session_end": "2025-12-09T14:30:00Z",
  "can_start": false,
  "reason": "Break period not yet completed",
  "allowed_devices": ["tv1"],
  "duration_minutes": 120
}
```

**Response (already used):**
```json
{
  "is_weekend": true,
  "is_bypass_active": false,
  "is_available": false,
  "is_used_today": true,
  "break_required": false,
  "break_minutes_left": 0,
  "can_start": false,
  "reason": "Movie time already used today",
  "allowed_devices": ["tv1"],
  "duration_minutes": 120
}
```

**Response (not weekend and no bypass):**
```json
{
  "is_weekend": false,
  "is_bypass_active": false,
  "is_available": false,
  "is_used_today": false,
  "break_required": false,
  "break_minutes_left": 0,
  "can_start": false,
  "reason": "Movie time is only available on weekends",
  "allowed_devices": ["tv1"],
  "duration_minutes": 120
}
```

**Fields:**
- `is_weekend`: Whether today is Saturday or Sunday
- `is_bypass_active`: Whether a bypass period is active (allows movie time on non-weekends)
- `bypass_reason`: Reason for the active bypass period (if applicable)
- `is_available`: Overall availability of movie time
- `is_used_today`: Whether movie time has already been used today
- `break_required`: Whether still in break period after last personal session
- `break_minutes_left`: Minutes until break ends (0 if met)
- `last_session_end`: When the last personal session ended
- `can_start`: Final decision - whether movie time can be started now
- `reason`: Human-readable reason if movie time cannot start
- `allowed_devices`: Device IDs allowed for movie time
- `duration_minutes`: Duration of movie time session

**Error Responses:**
- `401` - Not authenticated
- `404` - Movie time feature not enabled

#### POST /child/movie-time

Start a movie time session on the specified device.

**Headers:**
- `Authorization: Bearer <child-session-id>` or session cookie

**Request Body:**
```json
{
  "device_id": "tv1"
}
```

**Response:** (201 Created)
```json
{
  "id": "session-uuid",
  "device_id": "tv1",
  "device_type": "tv",
  "start_time": "2025-12-09T15:30:45Z",
  "remaining_minutes": 120,
  "status": "active",
  "is_movie_session": true
}
```

**Error Responses:**
- `400` - Cannot start movie time:
  - `NOT_WEEKEND` - Not a weekend
  - `ALREADY_USED` - Movie time already used today
  - `BREAK_NOT_MET` - Break period after last session not yet completed
  - `INVALID_DEVICE` - Device is not allowed for movie time
- `401` - Not authenticated
- `404` - Movie time feature not enabled (`MOVIE_TIME_DISABLED`)

**Note:** Movie time sessions:
- Are shared between all children (automatically includes all children)
- Do NOT count against individual screen-time quotas
- Have a fixed duration configured in the server (default: 120 minutes)
- Are limited to one per weekend day

---

### Statistics

#### GET /v1/stats/today

Get today's usage statistics for all children.

**Response:**
```json
{
  "date": "2025-12-09",
  "children": [
    {
      "child_id": "child-uuid",
      "child_name": "Alice",
      "today_used": 30,
      "today_remaining": 30,
      "today_limit": 60,
      "sessions_today": 2,
      "usage_percent": 50
    }
  ],
  "active_sessions": 1,
  "total_children": 2
}
```

---

## Telegram Bot Integration Examples

### 1. Get Today's Summary

```bash
GET /v1/stats/today
```

Display in Telegram:
```
üìä Today's Screen Time Summary
Date: 2025-12-09

üëß Alice
‚îú Used: 30 mins (50%)
‚îú Remaining: 30 mins
‚îî Sessions: 2

Active sessions: 1
```

### 2. Start a Session

Multi-step flow:
1. Select child (Alice, Bob, or Shared)
2. Select device (tv1, tv2, etc.) from `/v1/devices`
3. Select duration

```bash
POST /v1/sessions
{
  "device_id": "tv1",
  "child_ids": ["alice-uuid"],
  "minutes": 30
}
```

Telegram buttons:
- Step 1: üëß Alice | üë¶ Bob | üë®‚Äçüë©‚Äçüëß Shared (All)
- Step 2: üì∫ Living Room TV | üì∫ Bedroom TV
- Step 3: ‚è± +5 | +15 | +30 | +60 | +120 mins

### 3. Extend Session

```bash
PATCH /v1/sessions/{session-id}
{
  "action": "extend",
  "additional_minutes": 15
}
```

Telegram inline buttons:
- ‚è± +5 mins
- ‚è± +15 mins
- ‚è± +30 mins
- ‚è± +60 mins
- ‚è± +120 mins

### 4. Stop Session

```bash
PATCH /v1/sessions/{session-id}
{
  "action": "stop"
}
```

Telegram button:
- ‚èπ Stop Session

### 5. List Devices

```bash
GET /v1/devices
```

Display available devices:
```
üì∫ Available Devices
‚îú TV (Aqara)
‚îú PS5 (Not configured)
‚îî iPad (Not configured)
```

### 6. List Children

```bash
GET /v1/children
```

Display for selection:
```
üë∂ Select Children:
‚òë Alice (30/60 mins used)
‚òê Bob (0/60 mins used)
‚òë All Children (shared time)
```

---

## Error Responses

All errors follow TMF630 format:

```json
{
  "error": "Human-readable error message",
  "code": "ERROR_CODE"
}
```

### Common Error Codes:

- `UNAUTHORIZED` (401) - Missing or invalid API key
- `AUTH_REQUIRED` (401) - Authorization header required (agent endpoints)
- `INVALID_TOKEN` (401) - Invalid agent token
- `TOKEN_DISABLED` (403) - Agent token is disabled
- `DEVICE_NOT_AUTHORIZED` (403) - Agent not authorized for requested device
- `DEVICE_ID_REQUIRED` (400) - Missing device_id parameter
- `SESSION_NOT_FOUND` (404) - Session ID does not exist
- `CHILD_NOT_FOUND` (404) - Child ID does not exist
- `INSUFFICIENT_TIME` (400) - Child has insufficient remaining time
- `INVALID_REQUEST` (400) - Malformed request body
- `INVALID_ACTION` (400) - Invalid action specified
- `INTERNAL_ERROR` (500) - Server error

---

## Middleware

All requests pass through the following middleware:

1. **Request ID** - Adds unique `X-Request-ID` header
2. **Recovery** - Catches panics and returns 500 errors
3. **Logging** - Structured logging with component, request_id, method, path, status, latency
4. **Content-Type** - Enforces `application/json` for POST/PATCH requests
5. **Authentication** - Validates `X-Metron-Key` header (for /v1/* endpoints)

---

## Component-Based Logging

All API logs include `component=api` for easy filtering:

```json
{
  "timestamp": "2025-12-09T15:30:45Z",
  "level": "INFO",
  "msg": "HTTP request",
  "component": "api",
  "request_id": "uuid",
  "method": "POST",
  "path": "/v1/sessions",
  "status": 201,
  "latency": "15ms",
  "client_ip": "127.0.0.1"
}
```

Filter API logs:
```bash
./bin/metron -log-format json | jq 'select(.component == "api")'
```
